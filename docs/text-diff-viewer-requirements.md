# 纯文本差异对比工具 - 需求文档

> **项目名称**：文本差异对比工具
> **文档版本**：v1.0
> **创建日期**：2025-11-21
> **主要技术栈**：Vue3 + diff-match-patch (基于Levenshtein的完整差异解决方案)

---

## 1. 项目概述

### 1.1 项目背景与动机
当前市面上主流的差异对比工具（如 Git Diff 及相关工具）大多以**行为单位**进行差异分析，这种设计在版本控制等场景下非常实用，但在某些精细化对比场景中存在局限性：

**现有工具的不足**：
- 粒度过粗：只能识别整行的增删改，无法定位到行内具体的文本差异
- 视觉干扰：即使行内只有一个字符不同，也会标记整行为变更
- 应用局限：不适用于文案审查、配置对比等需要精细化差异识别的场景

**本项目的核心价值**：
通过 diff-match-patch 算法库（基于Levenshtein编辑距离理论），实现**字符级别**的精确差异检测，能够准确定位到具体的文本变化位置，为用户提供更精细化、更直观的差异对比体验。

### 1.2 项目定位
本项目旨在开发一个基于 Web 的纯文本差异对比工具，专注于**精细化文本差异分析**场景，为用户提供字符级别的精确差异检测和可视化展示能力。

**目标用户场景**：
- **文案审查**：精确定位对比不同版本文档的用词变化
- **配置管理**：识别配置文件中的关键参数变更
- **内容校对**：快速发现文本中的细微差异

## 2. 功能需求

### 2.1 数据输入
- **文件上传**：支持纯文本文件格式，包括但不限于 `.md`、`.csv`、`.txt`
- **文本输入**：提供文本输入框进行直接输入
- **数据要求**：必须提供两个对比数据（对比项与被对比项），支持混合输入方式

### 2.2 文本处理
- **内容预处理**：将文档内容拉平为单行字符串
- **换行处理策略**：
  - **标准化转换**：将 Windows (`\r\n`) 和旧版 Mac (`\r`) 换行符统一转换为 `\n`
  - **算法统一性**：基于 `\n` 进行 Levenshtein 算法计算，确保字符处理的标准化
  - **优势说明**：
    - 跨平台兼容，不依赖系统默认处理
    - 算法效率更高，单字符处理比多字符标识符更优
    - 避免自定义标识符与正常文本内容冲突的风险

### 2.3 核心算法
- **算法选择**：diff-match-patch（Google开源的高性能差异算法库）
- **理论基础**：基于Levenshtein编辑距离理论
- **核心功能**：
  - 获取编辑距离数值
  - 详细的差异序列（增删改的具体位置和内容）
  - 支持语义清理和优化
- **一期策略**：使用成熟库快速实现稳定功能
- **二期规划**：根据性能需求考虑自研优化算法

### 2.4 数据结构
- **差异记录存储**：使用列表结构存储差异信息
- **记录字段**：
  - 差异所在位置
  - 差异类型（新增/删除/修改）
  - 差异详情（具体字符内容）

### 2.5 可视化展示
- **展示平台**：基于 Vue3 的 Web 页面
- **颜色编码**：
  - 🔴 **红色背景**：被删除的文本内容
  - 🟢 **绿色背景**：新增的文本内容
  - 🔵 **蓝色背景**：修改后的文本内容
- **格式还原**：回溯文档的原始格式，保持可读性

---

## 3. 技术规格

### 3.1 前端技术栈
- **框架**：Vue 3.x
- **构建工具**：Vite
- **样式**：UnoCSS（原子化CSS框架）
- **UI组件库**：Element Plus
- **类型检查**：TypeScript

### 3.2 核心算法
- **算法库**：diff-match-patch (Google开源)
- **理论基础**：Levenshtein 编辑距离 + Myers 差异算法
- **时间复杂度**：O(m×n)，实际使用中有多种优化
- **空间复杂度**：O(m+n)，优化的内存使用
- **核心优势**：
  - 成熟稳定，广泛应用于Google多个产品
  - 内置语义优化，减少无意义差异标记
  - 同时提供编辑距离和详细差异序列

### 3.3 文本预处理规范
- **标准化函数**：统一换行符处理逻辑
- **处理流程**：原始文本 → 换行符标准化 → 算法输入
- **兼容性**：支持Windows (`\r\n`) 和 Mac (`\r`) 格式

### 3.4 差异记录数据结构
- **存储方式**：结构化列表存储差异信息
- **关键字段**：差异位置、类型（新增/删除/修改）、内容详情
- **扩展性**：预留可选字段支持特殊场景（如换行符标识）

---

## 4. 非功能性需求

### 4.1 性能策略
- **一期策略**：专注功能实现，暂不设定具体性能指标
- **用户容错**：如遇卡顿，用户可刷新浏览器重置状态
- **渐进优化**：基于用户反馈在后续版本中优化性能

### 4.2 兼容性要求
- 浏览器支持：Chrome 80+、Firefox 75+、Safari 13+、Edge 80+
- 响应式设计：支持桌面端和移动端

---

## 5. 用户交互流程

### 5.1 页面结构
- **数据输入页面**：主要操作界面
- **差异查看页面**：结果展示界面

### 5.2 数据输入页面设计
```
┌─────────────────────────────────────┐
│           文本差异对比工具             │
├─────────────────────────────────────┤
│ 对比项 1                             │
│ ┌─────────────────────────────────┐ │
│ │      [文件上传/输入区域]           │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 对比项 2                             │
│ ┌─────────────────────────────────┐ │
│ │      [文件上传/输入区域]           │ │
│ └─────────────────────────────────┘ │
│                                     │
│           [ 对比 ] 按钮              │
└─────────────────────────────────────┘
```

### 5.3 交互流程
1. **数据输入**：用户通过文件上传或文本输入提供两个对比数据
2. **触发对比**：点击"对比"按钮
3. **自动跳转**：完成计算后自动跳转到差异查看页面
4. **结果展示**：在差异查看页面显示详细的对比结果

### 5.4 设计理念
- **极简界面**：避免复杂配置，专注核心功能
- **一键操作**：简化用户操作路径
- **结果导向**：快速从输入到结果的完整流程

---

## 6. 错误处理机制

### 6.1 技术选型
- **UI组件库**：Element Plus
- **核心组件**：ElMessage、ElNotification、ElAlert
- **设计理念**：用户友好的错误提示，避免技术术语

### 6.2 错误分类和处理策略

#### 6.2.1 文件上传错误
| 错误场景 | 错误类型 | 提示信息 | 处理方式 |
|---------|---------|---------|---------|
| 文件格式不支持 | 警告 | 仅支持 .md、.csv、.txt 等纯文本文件 | 拦截上传，显示提示 |
| 文件过大 | 警告 | 文件大小不能超过 10MB | 拦截上传，显示提示 |
| 文件读取失败 | 错误 | 文件读取失败，请重新选择文件 | 显示错误信息 |

#### 6.2.2 数据验证错误
| 错误场景 | 错误类型 | 提示信息 | 处理方式 |
|---------|---------|---------|---------|
| 缺少对比数据 | 警告 | 请提供两个对比数据 | 禁用对比按钮，显示提示 |
| 数据内容相同 | 信息 | 两个文件内容完全相同，无需对比 | 显示信息提示 |

#### 6.2.3 计算过程错误
| 错误场景 | 错误类型 | 提示信息 | 处理方式 |
|---------|---------|---------|---------|
| 内存不足 | 错误 | 文件过大，计算时内存不足，请尝试较小的文件 | 停止计算，显示错误 |
| 计算超时 | 错误 | 计算超时，请尝试较小的文件或稍后重试 | 停止计算，显示错误 |

### 6.3 UI层面的错误处理

#### 6.3.1 输入页面错误提示
- **实时验证**：文件选择时立即验证格式和大小
- **视觉反馈**：错误状态下输入区域高亮显示
- **状态管理**：根据验证状态启用/禁用对比按钮

#### 6.3.2 对比按钮状态管理
- **正常状态**：显示"对比"，可点击
- **计算中状态**：显示"计算中..."，loading效果，禁用
- **错误状态**：恢复正常状态，显示相关错误信息

### 6.4 全局错误处理
- **Vue错误边界**：捕获组件渲染错误
- **Promise异常处理**：处理未捕获的异步错误
- **系统级错误**：网络错误、服务不可用等场景处理

### 6.5 错误日志策略
- **开发环境**：控制台详细错误信息，包含上下文
- **生产环境**：基础错误提示，避免暴露技术细节
- **可选扩展**：可接入错误监控服务（如Sentry）

## 7. 导出功能

### 7.1 功能概述
- **导出格式**：HTML文件
- **导出内容**：差异查看页面的完整渲染内容
- **用户体验**：导出文件可在浏览器中直接打开查看，保持与在线查看一致的效果

### 7.2 技术实现方案

#### 7.2.1 导出触发方式
- **按钮位置**：差异查看页面工具栏
- **按钮标签**："导出HTML"
- **图标**：下载图标

#### 7.2.2 导出内容结构
- **HTML文档**：包含完整head和body的独立网页文件
- **元数据信息**：对比时间、文件名、差异统计等基本信息
- **样式内联**：所有CSS样式内置在HTML中，确保离线可用
- **差异内容**：完整的对比结果，保持与在线查看一致的视觉效果

#### 7.2.3 实现流程
1. **内容提取**：获取页面中渲染的差异内容
2. **HTML构建**：包装为完整的HTML文档结构
3. **样式处理**：将必要的CSS样式内联到HTML中
4. **文件生成**：通过浏览器API触发文件下载

### 7.3 功能特点
- **样式保持**：导出文件与在线查看视觉效果完全一致
- **离线可用**：导出HTML文件可在无网络环境下查看
- **跨平台**：任何现代浏览器均可打开
- **文件名规范**：包含时间戳，便于管理

### 7.4 UI设计
- **导出按钮**：位于差异查看页面顶部工具栏，使用绿色主色调，配有下载图标
- **布局样式**：采用现代化的卡片式设计，使用UnoCSS原子化类名
- **差异高亮**：
  - 删除内容：红色背景 + 深红色文字，圆角边框
  - 新增内容：绿色背景 + 深绿色文字，圆角边框
  - 修改内容：蓝色背景 + 深蓝色文字，圆角边框
- **响应式设计**：支持桌面端和移动端的自适应布局

## 8. 二期优化功能

### 8.1 算法进度条
- **功能描述**：在Levenshtein算法计算过程中显示实时进度
- **技术方案**：
  - 基于矩阵填充进度计算（当前完成单元格数 / 总单元格数）
  - 使用Web Worker避免UI阻塞
  - 进度条替换对比按钮，显示计算百分比
- **用户体验价值**：
  - 大文件处理时提供可视化反馈
  - 避免用户感觉程序卡死
  - 提升整体交互体验
- **实现优先级**：二期优化（一期专注核心功能稳定性）

### 8.2 算法自研计划
- **自研差异算法**：基于一期使用经验，开发定制化的差异算法
- **性能优化**：针对特定使用场景优化算法性能
- **功能扩展**：增加语义理解、智能合并等高级功能

### 8.3 其他潜在优化方向
- [ ] 性能优化（大文件分块处理）
- [ ] 更多文件格式支持
- [ ] 对比历史记录功能

## 9. 已确认技术方案
- [x] **核心算法选择**：使用Google diff-match-patch库，基于Levenshtein理论
- [x] **实施策略**：一期使用成熟库快速实现，二期根据需要自研优化
- [x] **换行处理策略**：统一转换为 `\n`，确保跨平台兼容性和算法效率
- [x] **格式还原机制**：基于结构化差异记录实现准确的原始格式回溯
- [x] **用户交互流程**：简洁的两页面设计，一键对比操作
- [x] **错误处理机制**：基于ElementPlus的完整错误处理体系
- [x] **导出功能**：HTML格式导出，保持视觉效果一致
- [x] **CSS框架选择**：采用UnoCSS原子化CSS框架，提升开发体验和性能